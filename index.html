<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ted Creative Metals — Pattern-to-Etch Mockup Lab (v2)</title>
  <style>
    :root {
      --bg: #090d15;
      --panel: #0f1625;
      --panel-2: #111a2c;
      --line: #2a3853;
      --text: #e7eefb;
      --muted: #98a9c9;
      --accent: #63d1ff;
      --accent-2: #4ea6ff;
      --gold: #d8b666;
      --ok: #8df5bf;
      --err: #ffabab;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:
        radial-gradient(1200px 700px at 75% -10%, #1d2d4a 0%, rgba(10,14,24,0) 55%),
        radial-gradient(900px 500px at -10% 40%, #18243b 0%, rgba(10,14,24,0) 45%),
        var(--bg);
    }
    .wrap { max-width: 1300px; margin: 0 auto; padding: 20px; }
    .hero {
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 18px;
      background: linear-gradient(145deg, rgba(255,255,255,.03), rgba(255,255,255,.005));
      box-shadow: 0 20px 40px rgba(0,0,0,.25);
    }
    .hero h1 { margin: 0; font-size: clamp(1.35rem, 2.7vw, 2.15rem); }
    .hero p { margin: 9px 0 0; color: var(--muted); line-height: 1.4; }
    .pills { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }
    .pill { border: 1px solid #35507a; background: #0f1a32; color: #c9dcff; border-radius: 999px; padding: 5px 10px; font-size: .78rem; }

    .layout { margin-top: 14px; display:grid; gap:14px; }

    .controls-grid { display:grid; grid-template-columns: 440px 1fr; gap:14px; align-items:stretch; }
    @media (max-width: 1120px){ .controls-grid { grid-template-columns: 1fr; } }

    .card {
      border: 1px solid var(--line);
      border-radius: 14px;
      background: linear-gradient(155deg, rgba(255,255,255,.02), rgba(255,255,255,.004));
      padding: 12px;
    }

    label { display:block; font-size:.74rem; color:var(--muted); margin-bottom:6px; letter-spacing:.03em; text-transform:uppercase; }
    input[type="file"], input[type="text"], textarea, select {
      width: 100%;
      background: var(--panel-2);
      border: 1px solid #33445f;
      color: var(--text);
      border-radius: 10px;
      padding: 10px;
    }
    textarea { min-height: 76px; resize: vertical; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

    .btn {
      appearance: none; border: 1px solid #3f8ec0; background: linear-gradient(180deg, #12344b, #10293e);
      color: #e8f6ff; border-radius: 10px; padding: 11px 12px; cursor: pointer; font-weight: 700;
      transition: .15s transform ease;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn.secondary { background: #17253a; border-color: #384b6a; color: #d6e6ff; }
    .btn:disabled { opacity: .55; cursor: not-allowed; transform: none; }

    .tabs { display:flex; gap:6px; margin-bottom:8px; flex-wrap:wrap; }
    .tab {
      border:1px solid #365077; background:#0f1930; color:#cde0ff;
      border-radius:999px; padding:5px 10px; font-size:.75rem; cursor:pointer;
    }
    .tab.active { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(99,209,255,.2) inset; }

    .samples { display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; }
    .sample {
      border:1px solid #304865; border-radius:10px; background:#0e1a30;
      padding:8px; cursor:pointer; text-align:center; font-size:.78rem; color:#dbe9ff;
    }
    .sample.active { border-color:#65d5ff; box-shadow:0 0 0 2px rgba(99,209,255,.15) inset; }
    .sample svg { width:100%; height:72px; display:block; margin-bottom:5px; background:#fff; border-radius:6px; }

    .previewWrap { display:grid; grid-template-columns: 1fr; gap: 12px; }
    .hint { color: var(--muted); font-size: .85rem; margin-bottom: 6px; }

    .preview {
      border:1px solid #2f4563; border-radius:12px; background:#0c1425;
      min-height:520px; display:grid; place-items:center; overflow:hidden; position:relative;
    }
    .preview img, .preview svg { max-width:100%; max-height:840px; display:block; }

    .panel-head {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }

    .top-source {
      border:1px solid #2f4563;
      border-radius:12px;
      background:#0c1425;
      min-height:320px;
      display:grid;
      place-items:center;
      overflow:hidden;
      padding:10px;
    }
    .top-source img, .top-source svg { max-width:100%; max-height:420px; display:block; object-fit:contain; }

    .compare {
      position: relative;
      width: 100%;
      min-height: 460px;
      background: #0b1322;
      display: grid;
      place-items: center;
      overflow: hidden;
      border-radius: 12px;
      border: 1px solid #314563;
    }
    .compare .base, .compare .top {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      padding: 10px;
    }
    .compare .base img, .compare .top img {
      width: 100%;
      height: 100%;
      object-fit: contain; /* always show full image, never crop */
      object-position: center;
    }
    .compare .top { clip-path: inset(0 50% 0 0); }
    .divider {
      position: absolute; top:0; bottom:0; width:2px; background: #78d8ff; left:50%; pointer-events:none;
      box-shadow: 0 0 0 1px rgba(255,255,255,.25);
    }
    .sliderWrap { position:absolute; left:10px; right:10px; bottom:10px; }
    .sliderWrap input { width:100%; }

    .status { margin-top: 9px; font-size: .9rem; color: #a4d7ff; min-height: 24px; }
    .status.ok { color: var(--ok); }
    .status.error { color: var(--err); }

    .scene-grid {
      margin-top: 12px;
      display:grid;
      grid-template-columns: 2.35fr 1fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 900px){ .scene-grid { grid-template-columns: 1fr; } }
    .scene-card { border:1px solid #304763; border-radius:12px; background:#0f1a30; overflow:hidden; }
    .scene-head { display:flex; justify-content:space-between; gap:8px; padding:8px 10px; font-size:.78rem; color:#cde1ff; border-bottom:1px solid #2e425f; align-items:center; }
    .scene-actions { display:flex; gap:6px; }
    .scene-dl { padding:4px 8px; font-size:.7rem; }
    .scene-card img {
      width:100%;
      height:auto;
      max-height:520px;
      object-fit:contain;
      display:block;
      background:#0b1322;
    }
    .scene-card.portrait img { max-height:700px; }
    .scene-card.wall img { max-height:520px; }

    .scene-ph {
      min-height: 280px;
      display:grid;
      place-items:center;
      color:#a8bbda;
      background:
        linear-gradient(110deg, rgba(255,255,255,.02) 8%, rgba(255,255,255,.08) 18%, rgba(255,255,255,.02) 33%),
        #0b1322;
      background-size: 240% 100%;
      animation: shimmer 1.8s linear infinite;
      font-size:.85rem;
    }
    @keyframes shimmer {
      from { background-position: 130% 0; }
      to { background-position: -130% 0; }
    }

    .history { margin-top: 10px; border-top: 1px dashed #2f425f; padding-top: 10px; }
    .history h4 { margin:0 0 8px; font-size:.88rem; color:#cde3ff; }
    .hist-list { display:grid; gap:6px; max-height:180px; overflow:auto; }
    .hist {
      border:1px solid #30445f; border-radius:10px; padding:7px; background:#0f1a30;
      font-size:.78rem; color:#dbe7ff; display:flex; justify-content:space-between; gap:6px;
    }
    .muted { color: var(--muted); }
    .toolhead { display:flex; justify-content:space-between; gap:10px; align-items:center; }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="hero">
      <h1>Ted Creative Metals — Pattern-to-Etch Mockup Lab <span style="color:var(--accent)">v2</span></h1>
      <p>Upload SVG artwork (or pick a pattern library asset), then generate a photoreal etched brass/stainless panel preview with strict geometry fidelity — built to showcase premium architectural metalcraft.</p>
      <div class="pills">
        <span class="pill">Geometry lock mode</span>
        <span class="pill">Before/After compare slider</span>
        <span class="pill">Pattern categories</span>
        <span class="pill">Revision history</span>
      </div>
    </section>

    <div class="layout">
      <div class="controls-grid">
        <section class="card">
          <label>Upload SVG</label>
          <input id="svgFile" type="file" accept=".svg,image/svg+xml" />

          <div style="height:10px"></div>
          <label>Pattern library</label>
          <div class="tabs" id="sampleTabs"></div>
          <div class="samples" id="samples"></div>

          <div style="height:10px"></div>
          <div class="row">
            <div>
              <label>Metal</label>
              <select id="metal">
                <option value="brass">Brass</option>
                <option value="stainless">Stainless steel</option>
              </select>
            </div>
            <div>
              <label>Finish</label>
              <select id="finish">
                <option value="brushed">Brushed</option>
                <option value="polished">Polished</option>
                <option value="aged">Aged patina</option>
              </select>
            </div>
          </div>

          <div style="height:10px"></div>
          <label>Lighting scene</label>
          <select id="lighting">
            <option value="studio">Studio product shot</option>
            <option value="lobby">Architectural lobby</option>
            <option value="daylight">Soft daylight wall</option>
          </select>

          <div style="height:10px"></div>
          <label>Direction (optional)</label>
          <textarea id="direction" placeholder="Example: Keep satin brass, crisp black enamel grooves, slight angle, premium reflections."></textarea>

          <div style="height:12px"></div>
          <button id="go" class="btn">Generate Etched Mockup</button>
          <button id="download" class="btn secondary" disabled style="margin-top:8px">Download Main Mockup PNG</button>
          <button id="downloadAll" class="btn secondary" disabled style="margin-top:8px">Download All Scene PNGs</button>
          <button id="saveRev" class="btn secondary" disabled style="margin-top:8px">Save Revision Snapshot</button>
          <div id="status" class="status"></div>
        </section>

        <section class="card">
          <div class="hint">Source vector preview</div>
          <div id="srcPreviewTop" class="top-source"><div class="muted">Upload SVG or choose from library</div></div>
        </section>
      </div>

      <section class="card">
        <div class="panel-head">
          <div class="hint" style="margin:0">2D Compare Scan</div>
          <button id="downloadMainPanelTop" class="btn secondary" disabled style="padding:6px 9px;font-size:.72rem">Download Main PNG</button>
        </div>
        <div id="compareWrap" class="preview"><div class="muted">Generated etched output appears here</div></div>
      </section>

      <section class="card">
        <div class="hint" style="margin:0 0 8px">Installed context mockups</div>
        <div id="sceneGallery" class="scene-grid"></div>
      </section>

      <section class="card">
        <div class="toolhead">
          <h4>Revision History</h4>
          <button id="clearHistory" class="btn secondary" style="padding:5px 8px;font-size:.72rem">Clear</button>
        </div>
        <div id="historyList" class="hist-list"></div>
      </section>
    </div>
  </div>

<script>
const PROXY_URL = 'https://wbtpizrlayiedgwrtpwl.functions.supabase.co/gemini-proxy';
const HISTORY_KEY = 'tcm_mockup_history_v2';

const fallbackSampleData = [
  { category:'Geometric', name:'Deco Arches', svg:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 600 380'><rect width='600' height='380' fill='white'/><g fill='none' stroke='black' stroke-width='8'><path d='M40 340H560'/><path d='M80 340V120a220 220 0 0 1 440 0v220'/><path d='M160 340V150a140 140 0 0 1 280 0v190'/><path d='M240 340V180a60 60 0 0 1 120 0v160'/></g></svg>`},
  { category:'Organic', name:'Wave Mesh', svg:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 600 380'><rect width='600' height='380' fill='white'/><g fill='none' stroke='black' stroke-width='4'>${Array.from({length:13},(_,i)=>`<path d='M0 ${30+i*24} C120 ${i%2?10:50},240 ${i%2?50:10},360 ${30+i*24} S520 ${i%2?10:50},600 ${30+i*24}'/>`).join('')}</g></svg>`},
  { category:'Wayfinding', name:'North Star', svg:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 600 380'><rect width='600' height='380' fill='white'/><g stroke='black' fill='none' stroke-width='6' transform='translate(300 190)'><polygon points='0,-145 20,-20 145,0 20,20 0,145 -20,20 -145,0 -20,-20'/><circle r='72'/></g><text x='300' y='352' text-anchor='middle' fill='black' font-size='42' font-family='serif'>NORTH</text></svg>`}
];

let sampleData = [...fallbackSampleData];

function patternToTiledSvg(pattern, outW = 600, outH = 380){
  const tileW = Math.max(8, Number(pattern.width) || 40);
  const tileH = Math.max(8, Number(pattern.height) || 40);
  const cols = Math.ceil(outW / tileW) + 1;
  const rows = Math.ceil(outH / tileH) + 1;
  let tileContent = (pattern.svgPath || '').replace(/\n/g, ' ');

  if ((pattern.mode === 'stroke' || pattern.mode === 'stroke-join')) {
    tileContent = tileContent
      .replace(/stroke="[^"]*"/g, 'stroke="black"')
      .replace(/stroke='[^']*'/g, "stroke='black'")
      .replace(/fill="[^"]*"/g, 'fill="none"')
      .replace(/fill='[^']*'/g, "fill='none'");
    if (!/stroke=/.test(tileContent)) tileContent = tileContent.replace(/<path /g, '<path stroke="black" fill="none" ');
  } else {
    tileContent = tileContent
      .replace(/fill="[^"]*"/g, 'fill="black"')
      .replace(/fill='[^']*'/g, "fill='black'");
    if (!/fill=/.test(tileContent)) tileContent = tileContent.replace(/<path /g, '<path fill="black" stroke="none" ');
  }

  const groups = [];
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      groups.push(`<g transform="translate(${c*tileW},${r*tileH})">${tileContent}</g>`);
    }
  }

  return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 ${outW} ${outH}'><rect width='${outW}' height='${outH}' fill='white'/>${groups.join('')}</svg>`;
}

function normalizeCategory(tags){
  const raw = Array.isArray(tags) && tags.length ? String(tags[0]) : 'Pattern';
  return raw.charAt(0).toUpperCase() + raw.slice(1);
}

async function loadPatternLibrary(){
  const endpoints = [
    'https://cdn.jsdelivr.net/gh/MerlinDog1/svg-pattern-generator@main/public/svelte_patterns.json',
    'https://cdn.jsdelivr.net/gh/MerlinDog1/svg-pattern-generator@main/public/pattern_monster_patterns.json'
  ];

  try {
    setStatus('Loading SVG pattern library…');
    const results = await Promise.all(endpoints.map(url => fetch(url).then(r => r.ok ? r.json() : Promise.reject(new Error('fetch failed')))));
    const combined = results.flatMap(r => Array.isArray(r.patterns) ? r.patterns : []);
    const curated = combined.slice(0, 180).map((p, idx) => ({
      category: normalizeCategory(p.tags),
      name: p.name || ('Pattern ' + (idx + 1)),
      svg: patternToTiledSvg(p)
    }));

    if (curated.length) {
      sampleData = curated;
      activeCategory = 'All';
      selectedSampleName = '';
      buildTabs();
      renderSamples();
      setStatus(`Loaded ${curated.length} patterns from svg-pattern-generator.`, 'ok');
      return;
    }
    throw new Error('No patterns found in remote library');
  } catch (err) {
    console.warn('Pattern library load failed, using fallback samples.', err);
    sampleData = [...fallbackSampleData];
    buildTabs();
    renderSamples();
    setStatus('Using fallback pattern set (remote library unavailable).', 'error');
  }
}


let currentSvgText = '';
let currentSourcePngDataUrl = '';
let generatedDataUrl = '';
let generatedScenes = [];
let isGenerating = false;
let activeCategory = 'All';
let selectedSampleName = '';
let compareSplit = 50;

const samplesEl = document.getElementById('samples');
const tabsEl = document.getElementById('sampleTabs');
const srcPreviewTop = document.getElementById('srcPreviewTop');
const compareWrap = document.getElementById('compareWrap');
const statusEl = document.getElementById('status');
const goBtn = document.getElementById('go');
const dlBtn = document.getElementById('download');
const dlMainTopBtn = document.getElementById('downloadMainPanelTop');
const dlAllBtn = document.getElementById('downloadAll');
const saveRevBtn = document.getElementById('saveRev');
const historyList = document.getElementById('historyList');
const sceneGalleryEl = document.getElementById('sceneGallery');

const scenePresets = [
  {
    key:'wall',
    cls:'wall',
    title:'Floor-to-Ceiling Wall Cladding (~30°)',
    prompt:'Architectural perspective around 30 degrees. Show pattern distributed across several tall vertical panels from floor to ceiling in a premium interior. Real fabrication scale, no stylization.'
  },
  {
    key:'elevator',
    cls:'portrait',
    title:'Elevator Door Install (9:16 Vertical)',
    prompt:'Strict 9:16 vertical composition. Close-up of elevator exterior with a crisp vertical center seam where the two doors meet. Show stainless door rails and realistic mounting scale. Keep panel art unchanged.'
  }
];

const mainPanelPrompt = 'Flat orthographic face-on scan view. Entire panel fully visible edge-to-edge, centered, no perspective distortion, white/neutral background, clean technical product shot with minimal reflections.';


function setStatus(msg, type='info'){
  statusEl.className = `status ${type==='ok'?'ok':''} ${type==='error'?'error':''}`;
  statusEl.textContent = msg || '';
}

function fileToText(file){ return file.text(); }

function svgToPngDataUrl(svgText, outW=1600){
  return new Promise((resolve,reject)=>{
    const blob = new Blob([svgText], {type:'image/svg+xml;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const img = new Image();
    img.onload = () => {
      const ratio = img.width && img.height ? (img.height / img.width) : 0.66;
      const w = outW;
      const h = Math.max(440, Math.round(outW * ratio));
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,w,h);
      ctx.drawImage(img, 0, 0, w, h);
      URL.revokeObjectURL(url);
      resolve(canvas.toDataURL('image/png'));
    };
    img.onerror = () => { URL.revokeObjectURL(url); reject(new Error('Failed to rasterize SVG')); };
    img.src = url;
  });
}

function renderTopSource(){
  if(!currentSvgText){
    srcPreviewTop.innerHTML = '<div class="muted">Upload SVG or choose from library</div>';
    return;
  }
  srcPreviewTop.innerHTML = currentSvgText;
}

function buildTabs(){
  const cats = ['All', ...Array.from(new Set(sampleData.map(s => s.category)))];
  tabsEl.innerHTML = '';
  cats.forEach(cat => {
    const b = document.createElement('button');
    b.className = 'tab' + (cat===activeCategory ? ' active':'');
    b.textContent = cat;
    b.onclick = () => { activeCategory = cat; buildTabs(); renderSamples(); };
    tabsEl.appendChild(b);
  });
}

function renderSamples(){
  samplesEl.innerHTML = '';
  sampleData
    .filter(s => activeCategory === 'All' || s.category === activeCategory)
    .forEach(s => {
      const d = document.createElement('button');
      d.className = 'sample' + (selectedSampleName === s.name ? ' active':'');
      d.innerHTML = `${s.svg}<div>${s.name}</div>`;
      d.onclick = async () => {
        selectedSampleName = s.name;
        currentSvgText = s.svg;
        renderTopSource();
        currentSourcePngDataUrl = await svgToPngDataUrl(currentSvgText, 1200);
        generatedDataUrl = ''; generatedScenes = []; renderCompare(); renderSceneGallery();
        dlBtn.disabled = true; dlMainTopBtn.disabled = true; dlAllBtn.disabled = true; saveRevBtn.disabled = true;
        setStatus(`Loaded sample: ${s.name}`, 'ok');
        renderSamples();
      };
      samplesEl.appendChild(d);
    });
}

function renderCompare(){
  if(!generatedDataUrl){
    compareWrap.innerHTML = '<div class="muted">Generated etched output appears here</div>';
    return;
  }
  if(!currentSourcePngDataUrl){
    compareWrap.innerHTML = `<img src="${generatedDataUrl}" alt="Generated mockup">`;
    return;
  }
  compareWrap.innerHTML = `
    <div class="compare">
      <div class="base"><img src="${currentSourcePngDataUrl}" alt="Source"></div>
      <div id="topLayer" class="top" style="clip-path: inset(0 ${100-compareSplit}% 0 0)"><img src="${generatedDataUrl}" alt="Etched"></div>
      <div id="divider" class="divider" style="left:${compareSplit}%"></div>
      <div class="sliderWrap"><input id="compareSlider" type="range" min="0" max="100" value="${compareSplit}" /></div>
    </div>`;
  document.getElementById('compareSlider').addEventListener('input', (e)=>{
    compareSplit = Number(e.target.value);
    document.getElementById('topLayer').style.clipPath = `inset(0 ${100-compareSplit}% 0 0)`;
    document.getElementById('divider').style.left = `${compareSplit}%`;
  });
}


async function callImageModel(imageBase64, fullPrompt){
  const r = await fetch(PROXY_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      task: 'image',
      imageModel: 'gemini-3-pro-image-preview',
      prompt: fullPrompt,
      imageBase64,
      imageMimeType: 'image/png'
    })
  });
  const txt = await r.text();
  let j = {};
  try { j = JSON.parse(txt); } catch {}
  if(!r.ok) throw new Error(j.error || txt || `Request failed (${r.status})`);
  const b64 = j.bytesBase64Encoded;
  const mime = j.mimeType || 'image/png';
  if(!b64) throw new Error('No image returned by model.');
  return `data:${mime};base64,${b64}`;
}

function downloadDataUrl(dataUrl, filename){
  const a = document.createElement('a');
  a.href = dataUrl;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function renderSceneGallery(){
  const html = scenePresets.map((preset, i) => {
    const sc = generatedScenes.find(x => x.key === preset.key);
    const ready = !!sc?.dataUrl;
    return `
      <article class="scene-card ${preset.cls||''}">
        <div class="scene-head">
          <b>${preset.title}</b>
          <div class="scene-actions">
            <span class="muted">view ${i+2}</span>
            <button class="btn secondary scene-dl" data-scene-key="${preset.key}" ${ready ? '' : 'disabled'}>Download</button>
          </div>
        </div>
        ${ready ? `<img src="${sc.dataUrl}" alt="${preset.title}">` : `<div class="scene-ph">${isGenerating ? 'Building scene…' : 'Generate to build this scene'}</div>`}
      </article>
    `;
  }).join('');

  sceneGalleryEl.innerHTML = html;

  sceneGalleryEl.querySelectorAll('[data-scene-key]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const key = e.currentTarget.getAttribute('data-scene-key');
      const sc = generatedScenes.find(x => x.key === key);
      if(!sc) return;
      const safeName = sc.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
      downloadDataUrl(sc.dataUrl, `tcm-${safeName}-${Date.now()}.png`);
    });
  });
}

function getHistory(){
  try { return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); } catch { return []; }
}
function setHistory(arr){ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr.slice(0,12))); }

function renderHistory(){
  const arr = getHistory();
  historyList.innerHTML = arr.length ? '' : '<div class="muted">No revisions yet</div>';
  arr.forEach((h, idx) => {
    const d = document.createElement('div');
    d.className = 'hist';
    d.innerHTML = `<div><div><b>${h.sample || 'Uploaded SVG'}</b></div><div class="muted">${h.metal} · ${h.finish} · ${h.sceneCount||0} views</div><div class="muted">${new Date(h.ts).toLocaleString()}</div></div><button class="btn secondary" style="padding:5px 8px;font-size:.72rem">Reuse</button>`;
    d.querySelector('button').onclick = () => {
      document.getElementById('metal').value = h.metal;
      document.getElementById('finish').value = h.finish;
      document.getElementById('lighting').value = h.lighting;
      document.getElementById('direction').value = h.direction || '';
      setStatus('Loaded revision settings. (Select/upload source pattern if needed)', 'ok');
    };
    historyList.appendChild(d);
  });
}

document.getElementById('svgFile').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  try {
    const txt = await fileToText(f);
    if(!txt.includes('<svg')) throw new Error('File does not appear to be valid SVG.');
    selectedSampleName = '';
    currentSvgText = txt;
    renderTopSource();
    currentSourcePngDataUrl = await svgToPngDataUrl(currentSvgText, 1200);
    generatedDataUrl = ''; generatedScenes = []; renderCompare(); renderSceneGallery();
    dlBtn.disabled = true; dlMainTopBtn.disabled = true; dlAllBtn.disabled = true; saveRevBtn.disabled = true;
    setStatus(`Loaded ${f.name}`, 'ok');
    renderSamples();
  } catch (err) {
    setStatus(err.message || 'Failed to load SVG', 'error');
  }
});

async function generateMockup(){
  if(!currentSvgText){ setStatus('Upload SVG or choose a pattern first.', 'error'); return; }

  const metal = document.getElementById('metal').value;
  const finish = document.getElementById('finish').value;
  const lighting = document.getElementById('lighting').value;
  const direction = document.getElementById('direction').value.trim();

  goBtn.disabled = true;
  dlBtn.disabled = true;
  dlMainTopBtn.disabled = true;
  dlAllBtn.disabled = true;
  saveRevBtn.disabled = true;

  try {
    isGenerating = true;
    renderSceneGallery();
    setStatus('Rasterizing source vector…');
    const sourcePngDataUrl = await svgToPngDataUrl(currentSvgText, 1600);
    const imageBase64 = sourcePngDataUrl.split(',')[1];
    currentSourcePngDataUrl = sourcePngDataUrl;

    const strictLock = [
      'You are rendering a photoreal metal panel mockup from the provided monochrome vector mask.',
      'ABSOLUTE GEOMETRY LOCK:',
      '- Do NOT move, rotate, scale, crop, redraw, or restyle vector features.',
      '- Preserve exact line weights, spacing, proportions, and negative space.',
      '- Treat black regions as engraved/enamel geometry exactly as supplied.',
      '- Do not add or remove strokes, ornaments, textures, symbols, text, flourishes, or painterly brush effects.',
      '- Do NOT hallucinate extra artwork or background patterning inside the panel.',
      '- Metal should remain mostly clean; etch contrast comes from the provided vector only.',
      '- The output must align pixel-for-pixel with source geometry silhouette.',
      `Material: ${metal}. Finish: ${finish}. Lighting scene: ${lighting}.`,
      'Visual goal: premium architectural product photo for world-class etched brass/stainless panel fabrication.',
      'CRITICAL OUTPUT STYLE: realistic engraved metal panel, not an artistic painting or carved mural texture.',
      finish === 'aged' ? 'Aged patina should be subtle surface color variation only. No deep carved relief or gouged texture.' : '',
      direction ? `Additional direction: ${direction}` : ''
    ].filter(Boolean).join(' ');

    generatedScenes = [];

    setStatus('Rendering main panel…');
    generatedDataUrl = await callImageModel(imageBase64, [strictLock, `Scene directive: ${mainPanelPrompt}`].join(' '));
    compareSplit = 50;
    renderCompare();

    for (let i = 0; i < scenePresets.length; i++) {
      const sc = scenePresets[i];
      setStatus(`Rendering context ${i+1}/${scenePresets.length}: ${sc.title}…`);
      const scenePrompt = [strictLock, `Scene directive: ${sc.prompt}`].join(' ');
      const dataUrl = await callImageModel(imageBase64, scenePrompt);
      generatedScenes.push({ key: sc.key, cls: sc.cls, title: sc.title, dataUrl });
      renderSceneGallery();
    }

    dlBtn.disabled = false;
    dlMainTopBtn.disabled = false;
    dlAllBtn.disabled = false;
    saveRevBtn.disabled = false;
    setStatus(`Done. Built 3 views (main + ${generatedScenes.length} installed contexts).`, 'ok');
  } catch(err) {
    console.error(err);
    setStatus(err.message || 'Generation failed', 'error');
  } finally {
    isGenerating = false;
    renderSceneGallery();
    goBtn.disabled = false;
  }
}

function saveRevision(){
  if(!generatedDataUrl) return;
  const entry = {
    ts: Date.now(),
    sample: selectedSampleName,
    metal: document.getElementById('metal').value,
    finish: document.getElementById('finish').value,
    lighting: document.getElementById('lighting').value,
    direction: document.getElementById('direction').value.trim(),
    sceneCount: generatedScenes.length
  };
  const arr = getHistory();
  arr.unshift(entry);
  setHistory(arr);
  renderHistory();
renderSceneGallery();
  setStatus('Revision snapshot saved.', 'ok');
}

document.getElementById('go').addEventListener('click', generateMockup);
document.getElementById('saveRev').addEventListener('click', saveRevision);
document.getElementById('download').addEventListener('click', ()=>{
  if(!generatedDataUrl) return;
  downloadDataUrl(generatedDataUrl, `tcm-etched-mockup-main-${Date.now()}.png`);
});

document.getElementById('downloadMainPanelTop').addEventListener('click', ()=>{
  if(!generatedDataUrl) return;
  downloadDataUrl(generatedDataUrl, `tcm-etched-mockup-main-${Date.now()}.png`);
});

document.getElementById('downloadAll').addEventListener('click', async ()=>{
  if(!generatedDataUrl && !generatedScenes.length) return;
  const ts = Date.now();
  if (generatedDataUrl) {
    downloadDataUrl(generatedDataUrl, `tcm-01-main-panel-${ts}.png`);
    await new Promise(r => setTimeout(r, 180));
  }
  for (let i = 0; i < generatedScenes.length; i++) {
    const sc = generatedScenes[i];
    const safeName = sc.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
    downloadDataUrl(sc.dataUrl, `tcm-${String(i+2).padStart(2,'0')}-${safeName}-${ts}.png`);
    await new Promise(r => setTimeout(r, 180));
  }
  setStatus(`Started downloading ${generatedScenes.length + (generatedDataUrl ? 1 : 0)} PNG files.`, 'ok');
});
document.getElementById('clearHistory').addEventListener('click', ()=>{
  localStorage.removeItem(HISTORY_KEY);
  renderHistory();
renderSceneGallery();
  setStatus('Revision history cleared.');
});

buildTabs();
renderSamples();
loadPatternLibrary();
renderTopSource();
renderHistory();
renderSceneGallery();
</script>
</body>
</html>
