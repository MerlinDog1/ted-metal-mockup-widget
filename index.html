<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ted Creative Metals — Etched Mockup Lab</title>
  <style>
    :root {
      --bg: #0b0f17;
      --panel: #111827;
      --panel-2: #0f172a;
      --line: #263246;
      --text: #e5edf9;
      --muted: #9fb0cd;
      --accent: #5cc8ff;
      --gold: #d2ad53;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: radial-gradient(1200px 700px at 70% -10%, #1a2740 0%, var(--bg) 50%);
      color: var(--text);
    }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 22px; }
    .hero h1 { margin: 0; font-size: clamp(1.4rem, 3vw, 2.2rem); }
    .hero p { margin: 8px 0 0; color: var(--muted); }
    .grid { margin-top: 16px; display: grid; grid-template-columns: 420px 1fr; gap: 14px; }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }
    .card {
      background: linear-gradient(160deg, rgba(255,255,255,.02), rgba(255,255,255,.005));
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 14px;
    }
    label { display: block; font-size: .78rem; color: var(--muted); margin-bottom: 6px; letter-spacing: .03em; text-transform: uppercase; }
    input[type="file"], select, textarea, input[type="text"] {
      width: 100%; background: var(--panel-2); color: var(--text);
      border: 1px solid #334155; border-radius: 10px; padding: 10px;
    }
    textarea { min-height: 74px; resize: vertical; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .btn {
      appearance: none; border: 1px solid #36789a; background: #113147; color: #e7f5ff;
      border-radius: 10px; padding: 11px 12px; cursor: pointer; font-weight: 700;
    }
    .btn.secondary { background: #162236; border-color: #32445f; color: #d6e3f8; }
    .btn:disabled { opacity: .55; cursor: not-allowed; }
    .samples { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; }
    .sample {
      border: 1px solid #30425b; border-radius: 10px; background: #0f1b2f;
      padding: 8px; cursor: pointer; text-align: center; font-size: .8rem;
    }
    .sample svg { width: 100%; height: 72px; display: block; margin-bottom: 6px; background: #fff; border-radius: 6px; }
    .previewWrap { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 800px){ .previewWrap { grid-template-columns: 1fr; } }
    .preview {
      border: 1px solid #2f4058; border-radius: 12px; background: #0e1524;
      min-height: 360px; display: grid; place-items: center; overflow: hidden;
    }
    .preview img, .preview svg { max-width: 100%; max-height: 520px; display:block; }
    .hint { color: var(--muted); font-size: .88rem; }
    .status { margin-top: 10px; font-size: .9rem; color: #95c9ff; min-height: 22px; }
    .error { color: #ff9f9f; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>Ted Creative Metals — Etched Metal Mockup Lab</h1>
      <p>Upload an SVG (or choose a library pattern) and generate a photoreal etched brass/stainless mockup that stays true to your vector geometry.</p>
    </div>

    <div class="grid">
      <section class="card">
        <label>Upload SVG</label>
        <input id="svgFile" type="file" accept=".svg,image/svg+xml" />

        <div style="height:10px"></div>
        <label>Pattern Library</label>
        <div class="samples" id="samples"></div>

        <div style="height:10px"></div>
        <div class="row">
          <div>
            <label>Metal</label>
            <select id="metal">
              <option value="brass">Brass</option>
              <option value="stainless">Stainless</option>
            </select>
          </div>
          <div>
            <label>Finish</label>
            <select id="finish">
              <option value="brushed">Brushed</option>
              <option value="polished">Polished</option>
              <option value="aged">Aged / patina</option>
            </select>
          </div>
        </div>

        <div style="height:10px"></div>
        <div class="row">
          <div>
            <label>Mount style</label>
            <select id="mount">
              <option value="floating">Floating wall mount</option>
              <option value="screw-caps">Screw caps</option>
              <option value="wood-backer">Wood backer</option>
            </select>
          </div>
          <div>
            <label>Lighting</label>
            <select id="lighting">
              <option value="studio">Studio</option>
              <option value="lobby">Architectural lobby</option>
              <option value="daylight">Soft daylight</option>
            </select>
          </div>
        </div>

        <div style="height:10px"></div>
        <label>Direction (optional)</label>
        <textarea id="direction" placeholder="e.g. Keep ultra-crisp line edges, satin brass, deeper black enamel etch..."></textarea>

        <div style="height:12px"></div>
        <button id="go" class="btn">Generate Etched Mockup</button>
        <button id="download" class="btn secondary" disabled style="margin-top:8px">Download Mockup</button>
        <div id="status" class="status"></div>
      </section>

      <section class="card">
        <div class="previewWrap">
          <div>
            <div class="hint">Source Vector</div>
            <div id="srcPreview" class="preview"><div class="hint">Upload or choose a pattern</div></div>
          </div>
          <div>
            <div class="hint">Etched Metal Mockup (Nano Banana)</div>
            <div id="outPreview" class="preview"><div class="hint">Generated output will appear here</div></div>
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
const PROXY_URL = 'https://wbtpizrlayiedgwrtpwl.functions.supabase.co/gemini-proxy';
const samples = [
  { name:'Deco Arches', svg:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 600 380'><rect width='600' height='380' fill='white'/><g fill='none' stroke='black' stroke-width='8'><path d='M40 340H560'/><path d='M80 340V120a220 220 0 0 1 440 0v220'/><path d='M160 340V150a140 140 0 0 1 280 0v190'/><path d='M240 340V180a60 60 0 0 1 120 0v160'/></g></svg>`},
  { name:'Wave Mesh', svg:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 600 380'><rect width='600' height='380' fill='white'/><g fill='none' stroke='black' stroke-width='4'>${Array.from({length:13},(_,i)=>`<path d='M0 ${30+i*24} C120 ${i%2?10:50},240 ${i%2?50:10},360 ${30+i*24} S520 ${i%2?10:50},600 ${30+i*24}'/>`).join('')}</g></svg>`},
  { name:'Rosette', svg:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 600 380'><rect width='600' height='380' fill='white'/><g transform='translate(300 190)' fill='none' stroke='black' stroke-width='5'>${Array.from({length:24},(_,i)=>`<ellipse rx='24' ry='120' transform='rotate(${i*15})'/>`).join('')}<circle r='132'/><circle r='42'/></g></svg>`}
];

let currentSvgText = '';
let generatedDataUrl = '';

const samplesEl = document.getElementById('samples');
const srcPreview = document.getElementById('srcPreview');
const outPreview = document.getElementById('outPreview');
const statusEl = document.getElementById('status');
const goBtn = document.getElementById('go');
const dlBtn = document.getElementById('download');

function setStatus(msg, isErr=false){
  statusEl.className = 'status' + (isErr ? ' error' : '');
  statusEl.textContent = msg || '';
}

function renderSvgPreview(svgText){
  srcPreview.innerHTML = svgText;
}

async function fileToText(file){
  return await file.text();
}

function svgToPngBase64(svgText, outW=1600){
  return new Promise((resolve,reject)=>{
    const blob = new Blob([svgText], {type:'image/svg+xml;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const img = new Image();
    img.onload = () => {
      const ratio = img.width && img.height ? (img.height/img.width) : 0.66;
      const w = outW;
      const h = Math.max(400, Math.round(outW * ratio));
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,w,h);
      ctx.drawImage(img,0,0,w,h);
      URL.revokeObjectURL(url);
      resolve(canvas.toDataURL('image/png').split(',')[1]);
    };
    img.onerror = (e)=>{ URL.revokeObjectURL(url); reject(new Error('Failed to rasterize SVG')); };
    img.src = url;
  });
}

samples.forEach((s, i) => {
  const d = document.createElement('button');
  d.className = 'sample';
  d.innerHTML = `${s.svg}<div>${s.name}</div>`;
  d.onclick = () => {
    currentSvgText = s.svg;
    renderSvgPreview(currentSvgText);
    setStatus(`Loaded sample: ${s.name}`);
  };
  samplesEl.appendChild(d);
});

document.getElementById('svgFile').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  try {
    const txt = await fileToText(f);
    if(!txt.includes('<svg')) throw new Error('That does not look like an SVG file.');
    currentSvgText = txt;
    renderSvgPreview(currentSvgText);
    setStatus(`Loaded ${f.name}`);
  } catch (err) {
    setStatus(err.message || 'Failed to load SVG', true);
  }
});

document.getElementById('go').addEventListener('click', async ()=>{
  if(!currentSvgText){ setStatus('Upload an SVG or choose a sample first.', true); return; }

  const metal = document.getElementById('metal').value;
  const finish = document.getElementById('finish').value;
  const mount = document.getElementById('mount').value;
  const lighting = document.getElementById('lighting').value;
  const direction = document.getElementById('direction').value.trim();

  goBtn.disabled = true;
  dlBtn.disabled = true;
  setStatus('Rasterizing SVG…');

  try {
    const imageBase64 = await svgToPngBase64(currentSvgText);

    const prompt = [
      'Generate a high-definition photorealistic metal etching mockup from the provided mask image.',
      'CRITICAL: Preserve the vector geometry exactly. Do not alter line paths, spacing, proportions, or relative positions.',
      'Interpret black lines/filled marks from the mask as etched/enamel details in the final panel.',
      `Material: ${metal}. Finish: ${finish}. Mounting: ${mount}. Lighting: ${lighting}.`,
      'Scene: premium architectural product photography, realistic reflections and depth, true-to-pattern engraving.',
      direction ? `Extra direction: ${direction}` : ''
    ].filter(Boolean).join(' ');

    setStatus('Calling Nano Banana image model…');

    const r = await fetch(PROXY_URL, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        task: 'image',
        imageModel: 'gemini-3-pro-image-preview',
        prompt,
        imageBase64,
        imageMimeType: 'image/png'
      })
    });

    const t = await r.text();
    let j = {};
    try { j = JSON.parse(t); } catch {}
    if(!r.ok){ throw new Error(j.error || t || `Request failed (${r.status})`); }

    const b64 = j.bytesBase64Encoded;
    if(!b64) throw new Error('No image returned by model.');
    const mime = j.mimeType || 'image/png';
    generatedDataUrl = `data:${mime};base64,${b64}`;

    outPreview.innerHTML = `<img src="${generatedDataUrl}" alt="Etched mockup" />`;
    dlBtn.disabled = false;
    setStatus('Done. Mockup generated.');
  } catch (err) {
    console.error(err);
    setStatus(err.message || 'Generation failed', true);
  } finally {
    goBtn.disabled = false;
  }
});

document.getElementById('download').addEventListener('click', ()=>{
  if(!generatedDataUrl) return;
  const a = document.createElement('a');
  a.href = generatedDataUrl;
  a.download = `etched-mockup-${Date.now()}.png`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
});
</script>
</body>
</html>
