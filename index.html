<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ted Creative Metals — Pattern-to-Etch Mockup Lab (v2)</title>
  <style>
    :root {
      --bg: #090d15;
      --panel: #0f1625;
      --panel-2: #111a2c;
      --line: #2a3853;
      --text: #e7eefb;
      --muted: #98a9c9;
      --accent: #63d1ff;
      --accent-2: #4ea6ff;
      --gold: #d8b666;
      --ok: #8df5bf;
      --err: #ffabab;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background:
        radial-gradient(1200px 700px at 75% -10%, #1d2d4a 0%, rgba(10,14,24,0) 55%),
        radial-gradient(900px 500px at -10% 40%, #18243b 0%, rgba(10,14,24,0) 45%),
        var(--bg);
    }
    .wrap { max-width: 1300px; margin: 0 auto; padding: 20px; }
    .hero {
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 18px;
      background: linear-gradient(145deg, rgba(255,255,255,.03), rgba(255,255,255,.005));
      box-shadow: 0 20px 40px rgba(0,0,0,.25);
    }
    .hero h1 { margin: 0; font-size: clamp(1.35rem, 2.7vw, 2.15rem); }
    .hero p { margin: 9px 0 0; color: var(--muted); line-height: 1.4; }
    .pills { margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; }
    .pill { border: 1px solid #35507a; background: #0f1a32; color: #c9dcff; border-radius: 999px; padding: 5px 10px; font-size: .78rem; }

    .layout { margin-top: 14px; display:grid; gap:14px; }

    .controls-grid { display:grid; grid-template-columns: 440px 1fr; gap:14px; align-items:stretch; }
    @media (max-width: 1120px){ .controls-grid { grid-template-columns: 1fr; } }

    .card {
      border: 1px solid var(--line);
      border-radius: 14px;
      background: linear-gradient(155deg, rgba(255,255,255,.02), rgba(255,255,255,.004));
      padding: 12px;
      min-width: 0;
    }

    label { display:block; font-size:.74rem; color:var(--muted); margin-bottom:6px; letter-spacing:.03em; text-transform:uppercase; }
    input[type="file"], input[type="text"], textarea, select {
      width: 100%;
      background: var(--panel-2);
      border: 1px solid #33445f;
      color: var(--text);
      border-radius: 10px;
      padding: 10px;
    }
    textarea { min-height: 76px; resize: vertical; }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

    .btn {
      appearance: none; border: 1px solid #3f8ec0; background: linear-gradient(180deg, #12344b, #10293e);
      color: #e8f6ff; border-radius: 10px; padding: 11px 12px; cursor: pointer; font-weight: 700;
      transition: .15s transform ease;
    }
    .btn:hover { transform: translateY(-1px); }
    .btn.secondary { background: #17253a; border-color: #384b6a; color: #d6e6ff; }
    .btn:disabled { opacity: .55; cursor: not-allowed; transform: none; }

    .tabs { display:none; }

    .samples-wrap { position:relative; }
    .samples {
      display:flex;
      gap:12px;
      overflow-x:auto;
      max-width:100%;
      padding:8px calc(50% - 140px) 12px;
      scroll-snap-type:x mandatory;
      scrollbar-width:none;
      -ms-overflow-style:none;
      mask-image: linear-gradient(to right, transparent 0, black 10%, black 90%, transparent 100%);
      -webkit-mask-image: linear-gradient(to right, transparent 0, black 10%, black 90%, transparent 100%);
      scroll-behavior:smooth;
    }
    .samples::-webkit-scrollbar { display:none; }
    .sample {
      min-width:320px;
      width:320px;
      border:1px solid #304865;
      border-radius:14px;
      background:linear-gradient(180deg, #0f1d36, #0d1830);
      padding:9px;
      cursor:pointer;
      text-align:center;
      font-size:.88rem;
      color:#dbe9ff;
      flex:0 0 auto;
      scroll-snap-align:center;
      transition:transform .22s cubic-bezier(.2,.8,.2,1), border-color .2s ease, box-shadow .22s ease, opacity .22s ease;
      transform:scale(.92);
      opacity:.72;
      box-shadow:0 8px 24px rgba(0,0,0,.22);
    }
    @media (max-width: 760px){
      .samples { padding:8px calc(50% - 125px) 10px; }
      .sample { min-width:250px; width:250px; }
    }
    .sample:hover { transform:scale(.95) translateY(-1px); }
    .sample.active {
      border-color:#65d5ff;
      box-shadow:0 0 0 2px rgba(99,209,255,.22) inset, 0 18px 40px rgba(0,0,0,.38);
      transform:scale(1.04);
      opacity:1;
    }
    .sample.near { transform:scale(1); opacity:.94; }
    .sample.far { transform:scale(.9); opacity:.56; }
    .sample svg {
      width:100%;
      aspect-ratio:1/1;
      display:block;
      margin-bottom:6px;
      background:#fff;
      border-radius:8px;
      padding:0;
    }

    .previewWrap { display:grid; grid-template-columns: 1fr; gap: 12px; }
    .hint { color: var(--muted); font-size: .85rem; margin-bottom: 6px; }

    .preview {
      border:1px solid #2f4563; border-radius:12px; background:#0c1425;
      min-height:520px; display:grid; place-items:center; overflow:hidden; position:relative;
    }
    .preview.square-preview {
      min-height: auto;
      aspect-ratio: 1 / 1;
    }
    .preview img, .preview svg { max-width:100%; max-height:840px; display:block; }

    .panel-head {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }

    .top-source {
      border:1px solid #2f4563;
      border-radius:12px;
      background:#0c1425;
      aspect-ratio: 1 / 1;
      display:grid;
      place-items:center;
      overflow:hidden;
      padding:10px;
    }
    .top-source img, .top-source svg { max-width:100%; max-height:100%; display:block; object-fit:contain; }

    .compare-shell { width:100%; }
    .compare {
      position: relative;
      width: 100%;
      min-height: 460px;
      background: #0b1322;
      display: grid;
      place-items: center;
      overflow: hidden;
      border-radius: 12px;
      border: 1px solid #314563;
    }
    .compare .base, .compare .top {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      padding: 10px;
    }
    .compare .base img, .compare .top img {
      width: 100%;
      height: 100%;
      object-fit: contain; /* always show full image, never crop */
      object-position: center;
    }
    .compare .top { clip-path: inset(0 50% 0 0); }
    .divider {
      position: absolute; top:0; bottom:0; width:2px; background: #78d8ff; left:50%; pointer-events:none;
      box-shadow: 0 0 0 1px rgba(255,255,255,.25);
    }
    .sliderWrap {
      margin-top:10px;
      padding:8px 10px;
      border:1px solid #304763;
      border-radius:10px;
      background:#101a2f;
    }
    .sliderWrap input {
      width:100%;
      height:28px;
      accent-color:#63d1ff;
    }
    .sliderWrap input::-webkit-slider-thumb { width:20px; height:20px; }


    .status { margin-top: 9px; font-size: .9rem; color: #a4d7ff; min-height: 24px; }
    .status.ok { color: var(--ok); }
    .status.error { color: var(--err); }

    .scene-grid {
      margin-top: 12px;
      display:grid;
      grid-template-columns: 2.35fr 1fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 900px){ .scene-grid { grid-template-columns: 1fr; } }
    .scene-card { border:1px solid #304763; border-radius:12px; background:#0f1a30; overflow:hidden; }
    .scene-head { display:flex; justify-content:space-between; gap:8px; padding:8px 10px; font-size:.78rem; color:#cde1ff; border-bottom:1px solid #2e425f; align-items:center; }
    .scene-actions { display:flex; gap:6px; }
    .scene-dl { padding:4px 8px; font-size:.7rem; }
    .scene-card img {
      width:100%;
      height:auto;
      max-height:520px;
      object-fit:contain;
      display:block;
      background:#0b1322;
    }
    .scene-card.portrait img { max-height:700px; }
    .scene-card.wall img { max-height:520px; }

    .scene-ph {
      min-height: 280px;
      background:#0b1322;
    }

    .history { margin-top: 10px; border-top: 1px dashed #2f425f; padding-top: 10px; }
    .history h4 { margin:0 0 8px; font-size:.88rem; color:#cde3ff; }
    .hist-list { display:grid; gap:6px; max-height:180px; overflow:auto; }
    .hist {
      border:1px solid #30445f; border-radius:10px; padding:7px; background:#0f1a30;
      font-size:.78rem; color:#dbe7ff; display:flex; justify-content:space-between; gap:6px;
    }
    .muted { color: var(--muted); }
    .toolhead { display:flex; justify-content:space-between; gap:10px; align-items:center; }
  </style>
</head>
<body>
  <div class="wrap">
    <section class="hero">
      <h1>Ted Creative Metals — Pattern-to-Etch Mockup Lab <span style="color:var(--accent)">v2</span></h1>
      <p>Upload SVG artwork (or pick a pattern library asset), then generate a photoreal etched brass/stainless panel preview with strict geometry fidelity — built to showcase premium architectural metalcraft.</p>
      <div class="pills">
        <span class="pill">Geometry lock mode</span>
        <span class="pill">Before/After compare slider</span>
        <span class="pill">Pattern categories</span>
        <span class="pill">Revision history</span>
      </div>
    </section>

    <div class="layout">
      <div class="controls-grid">
        <section class="card">
          <label>Upload SVG</label>
          <input id="svgFile" type="file" accept=".svg,image/svg+xml" />

          <div style="height:10px"></div>
          <label>Pattern library (scroll sideways)</label>
          <div class="samples-wrap">
            <div class="samples" id="samples"></div>
          </div>

          <div style="height:10px"></div>
          <div class="row">
            <div>
              <label>Metal</label>
              <select id="metal">
                <option value="brass">Brass</option>
                <option value="stainless">Stainless steel</option>
              </select>
            </div>
            <div>
              <label>Finish</label>
              <select id="finish">
                <option value="brushed">Brushed</option>
                <option value="polished">Polished</option>
                <option value="aged">Aged patina</option>
              </select>
            </div>
          </div>

          <div style="height:10px"></div>
          <label>Lighting scene</label>
          <select id="lighting">
            <option value="studio">Studio product shot</option>
            <option value="lobby">Architectural lobby</option>
            <option value="daylight">Soft daylight wall</option>
          </select>

          <div style="height:10px"></div>
          <label>Direction (optional)</label>
          <textarea id="direction" placeholder="Example: Keep satin brass, crisp black enamel grooves, slight angle, premium reflections."></textarea>

          <div style="height:12px"></div>
          <button id="go" class="btn">Generate Etched Mockup</button>
          <button id="download" class="btn secondary" disabled style="margin-top:8px">Download Main Mockup PNG</button>
          <button id="downloadAll" class="btn secondary" disabled style="margin-top:8px">Download All Scene PNGs</button>
          <button id="saveRev" class="btn secondary" disabled style="margin-top:8px">Save Revision Snapshot</button>
          <div id="status" class="status"></div>
        </section>

        <section class="card">
          <div class="hint">Source vector preview</div>
          <div id="srcPreviewTop" class="top-source"><div class="muted">Upload SVG or choose from library</div></div>
        </section>
      </div>

      <section class="card">
        <div class="panel-head">
          <div class="hint" style="margin:0">2D Compare Scan</div>
          <button id="downloadMainPanelTop" class="btn secondary" disabled style="padding:6px 9px;font-size:.72rem">Download Main PNG</button>
        </div>
        <div id="compareWrap" class="preview square-preview"><div class="muted">Generated etched output appears here</div></div>
      </section>

      <section class="card">
        <div class="hint" style="margin:0 0 8px">Installed context mockups</div>
        <div id="sceneGallery" class="scene-grid"></div>
      </section>

      <section class="card">
        <div class="toolhead">
          <h4>Revision History</h4>
          <button id="clearHistory" class="btn secondary" style="padding:5px 8px;font-size:.72rem">Clear</button>
        </div>
        <div id="historyList" class="hist-list"></div>
      </section>
    </div>
  </div>

<script>
const PROXY_URL = 'https://wbtpizrlayiedgwrtpwl.functions.supabase.co/gemini-proxy';
const HISTORY_KEY = 'tcm_mockup_history_v2';

const fallbackSampleData = [
  { category:'Geometric', name:'Deco Arches', svg:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 600 380'><rect width='600' height='380' fill='white'/><g fill='none' stroke='black' stroke-width='8'><path d='M40 340H560'/><path d='M80 340V120a220 220 0 0 1 440 0v220'/><path d='M160 340V150a140 140 0 0 1 280 0v190'/><path d='M240 340V180a60 60 0 0 1 120 0v160'/></g></svg>`},
  { category:'Organic', name:'Wave Mesh', svg:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 600 380'><rect width='600' height='380' fill='white'/><g fill='none' stroke='black' stroke-width='4'>${Array.from({length:13},(_,i)=>`<path d='M0 ${30+i*24} C120 ${i%2?10:50},240 ${i%2?50:10},360 ${30+i*24} S520 ${i%2?10:50},600 ${30+i*24}'/>`).join('')}</g></svg>`},
  { category:'Wayfinding', name:'North Star', svg:`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 600 380'><rect width='600' height='380' fill='white'/><g stroke='black' fill='none' stroke-width='6' transform='translate(300 190)'><polygon points='0,-145 20,-20 145,0 20,20 0,145 -20,20 -145,0 -20,-20'/><circle r='72'/></g><text x='300' y='352' text-anchor='middle' fill='black' font-size='42' font-family='serif'>NORTH</text></svg>`}
];

let sampleData = [...fallbackSampleData];

function patternToTiledSvg(pattern, outW = 600, outH = 600){
  const tileW = Math.max(8, Number(pattern.width) || 40);
  const tileH = Math.max(8, Number(pattern.height) || 40);
  const cols = Math.ceil(outW / tileW) + 1;
  const rows = Math.ceil(outH / tileH) + 1;
  let tileContent = (pattern.svgPath || '').replace(/\n/g, ' ');

  if ((pattern.mode === 'stroke' || pattern.mode === 'stroke-join')) {
    tileContent = tileContent
      .replace(/stroke="[^"]*"/g, 'stroke="black"')
      .replace(/stroke='[^']*'/g, "stroke='black'")
      .replace(/fill="[^"]*"/g, 'fill="none"')
      .replace(/fill='[^']*'/g, "fill='none'");
    if (!/stroke=/.test(tileContent)) tileContent = tileContent.replace(/<path /g, '<path stroke="black" fill="none" ');
  } else {
    tileContent = tileContent
      .replace(/fill="[^"]*"/g, 'fill="black"')
      .replace(/fill='[^']*'/g, "fill='black'");
    if (!/fill=/.test(tileContent)) tileContent = tileContent.replace(/<path /g, '<path fill="black" stroke="none" ');
  }

  const groups = [];
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      groups.push(`<g transform="translate(${c*tileW},${r*tileH})">${tileContent}</g>`);
    }
  }

  return `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 ${outW} ${outH}'><rect width='${outW}' height='${outH}' fill='white'/>${groups.join('')}</svg>`;
}

function normalizeCategory(tags){
  const raw = Array.isArray(tags) && tags.length ? String(tags[0]) : 'Pattern';
  return raw.charAt(0).toUpperCase() + raw.slice(1);
}

async function loadPatternLibrary(){
  const localEndpoint = './data/pattern-library.json';
  const remoteEndpoints = [
    'https://cdn.jsdelivr.net/gh/MerlinDog1/svg-pattern-generator@main/public/svelte_patterns.json',
    'https://cdn.jsdelivr.net/gh/MerlinDog1/svg-pattern-generator@main/public/pattern_monster_patterns.json'
  ];

  try {
    setStatus('Loading SVG pattern library…');

    let combined = [];

    // 1) Prefer local bundled library (works on GitHub Pages reliably)
    try {
      const localResp = await fetch(localEndpoint);
      if (localResp.ok) {
        const localJson = await localResp.json();
        combined = Array.isArray(localJson.patterns) ? localJson.patterns : [];
      }
    } catch {}

    // 2) If local is empty, fallback to remote source repo
    if (!combined.length) {
      const results = await Promise.all(remoteEndpoints.map(url => fetch(url).then(r => r.ok ? r.json() : Promise.reject(new Error('fetch failed')))));
      combined = results.flatMap(r => Array.isArray(r.patterns) ? r.patterns : []);
    }

    const curated = combined.slice(0, 180).map((p, idx) => ({
      category: normalizeCategory(p.tags),
      name: p.name || ('Pattern ' + (idx + 1)),
      svg: patternToTiledSvg(p)
    }));

    if (curated.length) {
      sampleData = curated;
      selectedSampleName = '';
      renderSamples();
      setStatus(`Loaded ${curated.length} patterns from svg-pattern-generator.`, 'ok');
      return;
    }
    throw new Error('No patterns found in pattern library');
  } catch (err) {
    console.warn('Pattern library load failed, using fallback samples.', err);
    sampleData = [...fallbackSampleData];
    renderSamples();
    setStatus('Using fallback pattern set (pattern library unavailable).', 'error');
  }
}


let currentSvgText = '';
let currentSourcePngDataUrl = '';
let generatedDataUrl = '';
let generatedScenes = [];
let isGenerating = false;
let selectedSampleName = '';
let compareSplit = 50;

const samplesEl = document.getElementById('samples');
const srcPreviewTop = document.getElementById('srcPreviewTop');
const compareWrap = document.getElementById('compareWrap');
const statusEl = document.getElementById('status');
const goBtn = document.getElementById('go');
const dlBtn = document.getElementById('download');
const dlMainTopBtn = document.getElementById('downloadMainPanelTop');
const dlAllBtn = document.getElementById('downloadAll');
const saveRevBtn = document.getElementById('saveRev');
const historyList = document.getElementById('historyList');
const sceneGalleryEl = document.getElementById('sceneGallery');

const scenePresets = [
  {
    key:'wall',
    cls:'wall',
    title:'Floor-to-Ceiling Wall Cladding (~30°)',
    prompt:'Strict 16:9 landscape composition. Architectural perspective around 30 degrees. Show pattern distributed across several tall vertical panels from floor to ceiling in a premium interior. Scale panel art down slightly so full composition breathes with visible margins. Real fabrication scale, no stylization.'
  },
  {
    key:'elevator',
    cls:'portrait',
    title:'Elevator Door Install (9:16 Vertical)',
    prompt:'Strict 9:16 vertical composition. Close-up of elevator exterior with a crisp vertical center seam where the two doors meet. Show stainless door rails and realistic mounting scale. Scale panel artwork down slightly within door area for cleaner framing. Keep panel art unchanged.'
  }
];

const mainPanelPrompt = 'Flat orthographic face-on scan view of a square metal panel. Entire square panel fully visible, centered, no perspective distortion, white/neutral background, clean technical product shot with minimal reflections.';


function setStatus(msg, type='info'){
  statusEl.className = `status ${type==='ok'?'ok':''} ${type==='error'?'error':''}`;
  statusEl.textContent = msg || '';
}

function fileToText(file){ return file.text(); }

function svgToPngDataUrl(svgText, outW=1600, outH=null, fitScale=1){
  return new Promise((resolve,reject)=>{
    const blob = new Blob([svgText], {type:'image/svg+xml;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const img = new Image();
    img.onload = () => {
      const srcRatio = img.width && img.height ? (img.width / img.height) : 1;
      const w = outW;
      const h = outH || Math.max(440, Math.round(outW / srcRatio));
      const canvas = document.createElement('canvas');
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,w,h);

      const fit = Math.min(w / img.width, h / img.height) * fitScale;
      const drawW = img.width * fit;
      const drawH = img.height * fit;
      const dx = (w - drawW) / 2;
      const dy = (h - drawH) / 2;
      ctx.drawImage(img, dx, dy, drawW, drawH);

      URL.revokeObjectURL(url);
      resolve(canvas.toDataURL('image/png'));
    };
    img.onerror = () => { URL.revokeObjectURL(url); reject(new Error('Failed to rasterize SVG')); };
    img.src = url;
  });
}

function renderTopSource(){
  if(!currentSvgText){
    srcPreviewTop.innerHTML = '<div class="muted">Upload SVG or choose from library</div>';
    return;
  }
  srcPreviewTop.innerHTML = currentSvgText;
}

function updateCarouselDepth(){
  const cards = samplesEl.querySelectorAll('.sample');
  if(!cards.length) return;
  const wrapRect = samplesEl.getBoundingClientRect();
  const centerX = wrapRect.left + (wrapRect.width / 2);

  cards.forEach(card => {
    const r = card.getBoundingClientRect();
    const cardCenter = r.left + (r.width / 2);
    const dist = Math.abs(centerX - cardCenter);
    card.classList.remove('near','far');
    if (dist < r.width * 0.45) card.classList.add('near');
    else if (dist > r.width * 0.95) card.classList.add('far');
  });
}

function renderSamples(){
  samplesEl.innerHTML = '';
  sampleData.forEach(s => {
      const d = document.createElement('button');
      d.className = 'sample' + (selectedSampleName === s.name ? ' active':'');
      d.innerHTML = `${s.svg}<div>${s.name}</div>`;
      d.onclick = async () => {
        selectedSampleName = s.name;
        d.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
        currentSvgText = s.svg;
        renderTopSource();
        currentSourcePngDataUrl = await svgToPngDataUrl(currentSvgText, 1200);
        generatedDataUrl = ''; generatedScenes = []; renderCompare(); renderSceneGallery();
        dlBtn.disabled = true; dlMainTopBtn.disabled = true; dlAllBtn.disabled = true; saveRevBtn.disabled = true;
        setStatus(`Loaded sample: ${s.name}`, 'ok');
        renderSamples();
      };
      samplesEl.appendChild(d);
    });

  updateCarouselDepth();
}

function renderCompare(){
  if(!generatedDataUrl){
    compareWrap.innerHTML = '<div class="muted">Generated etched output appears here</div>';
    return;
  }
  if(!currentSourcePngDataUrl){
    compareWrap.innerHTML = `<img src="${generatedDataUrl}" alt="Generated mockup">`;
    return;
  }
  compareWrap.innerHTML = `
    <div class="compare-shell">
      <div id="compareCanvas" class="compare">
        <div class="base"><img src="${currentSourcePngDataUrl}" alt="Source"></div>
        <div id="topLayer" class="top" style="clip-path: inset(0 ${100-compareSplit}% 0 0)"><img src="${generatedDataUrl}" alt="Etched"></div>
        <div id="divider" class="divider" style="left:${compareSplit}%"></div>
      </div>
      <div class="sliderWrap"><input id="compareSlider" type="range" min="0" max="100" value="${compareSplit}" /></div>
    </div>`;

  const slider = document.getElementById('compareSlider');
  const topLayer = document.getElementById('topLayer');
  const divider = document.getElementById('divider');

  const applySplit = (v) => {
    compareSplit = Math.max(0, Math.min(100, Number(v) || 0));
    topLayer.style.clipPath = `inset(0 ${100-compareSplit}% 0 0)`;
    divider.style.left = `${compareSplit}%`;
    slider.value = String(compareSplit);
  };

  slider.addEventListener('input', (e)=> applySplit(e.target.value));
  slider.addEventListener('change', (e)=> applySplit(e.target.value));
}


async function callImageModel(imageBase64, fullPrompt){
  const r = await fetch(PROXY_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      task: 'image',
      imageModel: 'gemini-3-pro-image-preview',
      prompt: fullPrompt,
      imageBase64,
      imageMimeType: 'image/png'
    })
  });
  const txt = await r.text();
  let j = {};
  try { j = JSON.parse(txt); } catch {}
  if(!r.ok) throw new Error(j.error || txt || `Request failed (${r.status})`);
  const b64 = j.bytesBase64Encoded;
  const mime = j.mimeType || 'image/png';
  if(!b64) throw new Error('No image returned by model.');
  return `data:${mime};base64,${b64}`;
}

function downloadDataUrl(dataUrl, filename){
  const a = document.createElement('a');
  a.href = dataUrl;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
}

function renderSceneGallery(){
  const html = scenePresets.map((preset, i) => {
    const sc = generatedScenes.find(x => x.key === preset.key);
    const ready = !!sc?.dataUrl;
    return `
      <article class="scene-card ${preset.cls||''}">
        <div class="scene-head">
          <b>${preset.title}</b>
          <div class="scene-actions">
            <span class="muted">view ${i+2}</span>
            <button class="btn secondary scene-dl" data-scene-key="${preset.key}" ${ready ? '' : 'disabled'}>Download</button>
          </div>
        </div>
        ${ready ? `<img src="${sc.dataUrl}" alt="${preset.title}">` : `<div class="scene-ph"></div>`}
      </article>
    `;
  }).join('');

  sceneGalleryEl.innerHTML = html;

  sceneGalleryEl.querySelectorAll('[data-scene-key]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const key = e.currentTarget.getAttribute('data-scene-key');
      const sc = generatedScenes.find(x => x.key === key);
      if(!sc) return;
      const safeName = sc.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
      downloadDataUrl(sc.dataUrl, `tcm-${safeName}-${Date.now()}.png`);
    });
  });
}

function getHistory(){
  try { return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]'); } catch { return []; }
}
function setHistory(arr){ localStorage.setItem(HISTORY_KEY, JSON.stringify(arr.slice(0,12))); }

function renderHistory(){
  const arr = getHistory();
  historyList.innerHTML = arr.length ? '' : '<div class="muted">No revisions yet</div>';
  arr.forEach((h, idx) => {
    const d = document.createElement('div');
    d.className = 'hist';
    d.innerHTML = `<div><div><b>${h.sample || 'Uploaded SVG'}</b></div><div class="muted">${h.metal} · ${h.finish} · ${h.sceneCount||0} views</div><div class="muted">${new Date(h.ts).toLocaleString()}</div></div><button class="btn secondary" style="padding:5px 8px;font-size:.72rem">Reuse</button>`;
    d.querySelector('button').onclick = () => {
      document.getElementById('metal').value = h.metal;
      document.getElementById('finish').value = h.finish;
      document.getElementById('lighting').value = h.lighting;
      document.getElementById('direction').value = h.direction || '';
      setStatus('Loaded revision settings. (Select/upload source pattern if needed)', 'ok');
    };
    historyList.appendChild(d);
  });
}

document.getElementById('svgFile').addEventListener('change', async (e)=>{
  const f = e.target.files?.[0];
  if(!f) return;
  try {
    const txt = await fileToText(f);
    if(!txt.includes('<svg')) throw new Error('File does not appear to be valid SVG.');
    selectedSampleName = '';
    currentSvgText = txt;
    renderTopSource();
    currentSourcePngDataUrl = await svgToPngDataUrl(currentSvgText, 1200);
    generatedDataUrl = ''; generatedScenes = []; renderCompare(); renderSceneGallery();
    dlBtn.disabled = true; dlMainTopBtn.disabled = true; dlAllBtn.disabled = true; saveRevBtn.disabled = true;
    setStatus(`Loaded ${f.name}`, 'ok');
    renderSamples();
  } catch (err) {
    setStatus(err.message || 'Failed to load SVG', 'error');
  }
});

async function generateMockup(){
  if(!currentSvgText){ setStatus('Upload SVG or choose a pattern first.', 'error'); return; }

  const metal = document.getElementById('metal').value;
  const finish = document.getElementById('finish').value;
  const lighting = document.getElementById('lighting').value;
  const direction = document.getElementById('direction').value.trim();

  goBtn.disabled = true;
  dlBtn.disabled = true;
  dlMainTopBtn.disabled = true;
  dlAllBtn.disabled = true;
  saveRevBtn.disabled = true;

  try {
    isGenerating = true;
    renderSceneGallery();
    setStatus('Rasterizing source vector variants…');
    const sourceMainPng = await svgToPngDataUrl(currentSvgText, 1600, 1600, 0.96);   // 1:1 for compare
    const sourceWallPng = await svgToPngDataUrl(currentSvgText, 1920, 1080, 0.9);     // 16:9, slightly scaled down
    const sourceElevatorPng = await svgToPngDataUrl(currentSvgText, 1080, 1920, 0.9); // 9:16, slightly scaled down

    currentSourcePngDataUrl = sourceMainPng;

    const imageBase64ByScene = {
      main: sourceMainPng.split(',')[1],
      wall: sourceWallPng.split(',')[1],
      elevator: sourceElevatorPng.split(',')[1]
    };

    const strictLock = [
      'You are rendering a photoreal metal panel mockup from the provided monochrome vector mask.',
      'ABSOLUTE GEOMETRY LOCK:',
      '- Do NOT move, rotate, scale, crop, redraw, or restyle vector features.',
      '- Preserve exact line weights, spacing, proportions, and negative space.',
      '- Treat black regions as engraved/enamel geometry exactly as supplied.',
      '- Do not add or remove strokes, ornaments, textures, symbols, text, flourishes, or painterly brush effects.',
      '- Do NOT hallucinate extra artwork or background patterning inside the panel.',
      '- Metal should remain mostly clean; etch contrast comes from the provided vector only.',
      '- The output must align pixel-for-pixel with source geometry silhouette.',
      `Material: ${metal}. Finish: ${finish}. Lighting scene: ${lighting}.`,
      'Visual goal: premium architectural product photo for world-class etched brass/stainless panel fabrication.',
      'CRITICAL OUTPUT STYLE: realistic engraved metal panel, not an artistic painting or carved mural texture.',
      finish === 'aged' ? 'Aged patina should be subtle surface color variation only. No deep carved relief or gouged texture.' : '',
      direction ? `Additional direction: ${direction}` : ''
    ].filter(Boolean).join(' ');

    generatedScenes = [];

    setStatus('Rendering main panel (1:1 square)…');
    generatedDataUrl = await callImageModel(imageBase64ByScene.main, [strictLock, `Scene directive: ${mainPanelPrompt} Strict aspect ratio: 1:1 square.`].join(' '));
    compareSplit = 50;
    renderCompare();

    for (let i = 0; i < scenePresets.length; i++) {
      const sc = scenePresets[i];
      setStatus(`Rendering context ${i+1}/${scenePresets.length}: ${sc.title}…`);
      const scenePrompt = [strictLock, `Scene directive: ${sc.prompt}`].join(' ');
      const sceneBase64 = imageBase64ByScene[sc.key] || imageBase64ByScene.main;
      const dataUrl = await callImageModel(sceneBase64, scenePrompt);
      generatedScenes.push({ key: sc.key, cls: sc.cls, title: sc.title, dataUrl });
      renderSceneGallery();
    }

    dlBtn.disabled = false;
    dlMainTopBtn.disabled = false;
    dlAllBtn.disabled = false;
    saveRevBtn.disabled = false;
    setStatus(`Done. Built 3 views (main + ${generatedScenes.length} installed contexts).`, 'ok');
  } catch(err) {
    console.error(err);
    setStatus(err.message || 'Generation failed', 'error');
  } finally {
    isGenerating = false;
    renderSceneGallery();
    goBtn.disabled = false;
  }
}

function saveRevision(){
  if(!generatedDataUrl) return;
  const entry = {
    ts: Date.now(),
    sample: selectedSampleName,
    metal: document.getElementById('metal').value,
    finish: document.getElementById('finish').value,
    lighting: document.getElementById('lighting').value,
    direction: document.getElementById('direction').value.trim(),
    sceneCount: generatedScenes.length
  };
  const arr = getHistory();
  arr.unshift(entry);
  setHistory(arr);
  renderHistory();
renderSceneGallery();
  setStatus('Revision snapshot saved.', 'ok');
}

document.getElementById('go').addEventListener('click', generateMockup);
document.getElementById('saveRev').addEventListener('click', saveRevision);
document.getElementById('download').addEventListener('click', ()=>{
  if(!generatedDataUrl) return;
  downloadDataUrl(generatedDataUrl, `tcm-etched-mockup-main-${Date.now()}.png`);
});

document.getElementById('downloadMainPanelTop').addEventListener('click', ()=>{
  if(!generatedDataUrl) return;
  downloadDataUrl(generatedDataUrl, `tcm-etched-mockup-main-${Date.now()}.png`);
});

document.getElementById('downloadAll').addEventListener('click', async ()=>{
  if(!generatedDataUrl && !generatedScenes.length) return;
  const ts = Date.now();
  if (generatedDataUrl) {
    downloadDataUrl(generatedDataUrl, `tcm-01-main-panel-${ts}.png`);
    await new Promise(r => setTimeout(r, 180));
  }
  for (let i = 0; i < generatedScenes.length; i++) {
    const sc = generatedScenes[i];
    const safeName = sc.title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
    downloadDataUrl(sc.dataUrl, `tcm-${String(i+2).padStart(2,'0')}-${safeName}-${ts}.png`);
    await new Promise(r => setTimeout(r, 180));
  }
  setStatus(`Started downloading ${generatedScenes.length + (generatedDataUrl ? 1 : 0)} PNG files.`, 'ok');
});
document.getElementById('clearHistory').addEventListener('click', ()=>{
  localStorage.removeItem(HISTORY_KEY);
  renderHistory();
renderSceneGallery();
  setStatus('Revision history cleared.');
});

renderSamples();
loadPatternLibrary();
renderTopSource();
renderHistory();
renderSceneGallery();

samplesEl.addEventListener('scroll', updateCarouselDepth, { passive:true });
window.addEventListener('resize', updateCarouselDepth);
</script>
</body>
</html>
